<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì—ì´ì „íŠ¸ Alpha - ë¡œê·¸ì¸</title>
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/5/w3.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<!--    <link rel="stylesheet" href="/css/chat.css">-->
    <link rel="stylesheet" href="/css/form.css">
</head>
<body>
    <div class="form-container">
        <!-- Theme Toggle Button -->
        <div class="theme-toggle-container">
            <button class="theme-toggle" id="themeToggle">
                <div class="theme-toggle-slider">
                    <span class="theme-icon theme-icon-dark">ğŸŒ™</span>
                    <span class="theme-icon theme-icon-light">â˜€ï¸</span>
                </div>
            </button>
        </div>

        <div class="form-card">
            <div class="form-header">
                <h1 class="form-logo">
                    <img src="/image/mobius-nox.gif" alt="Mobius" class="login-gif-icon" />
                </h1>

                <p class="form-title">ê³„ì •ì— ë¡œê·¸ì¸í•˜ì—¬ AI ì–´ì‹œìŠ¤í„´íŠ¸ì™€ ëŒ€í™”í•˜ì„¸ìš”</p>
            </div>

            <form name="form-login" class="form-area">
                <div class="error-message" id="errorMessage"></div>
                
                <div class="form-group">
                    <label for="user_id" class="form-label">ì•„ì´ë””</label>
                    <input 
                        type="text" 
                        id="user_id"
                        name="user_id"
                        class="form-input" 
                        placeholder="ì•„ì´ë””ë¥¼ ì…ë ¥í•˜ì„¸ìš”"
                        required
                    />
                </div>

                <div class="form-group">
                    <label for="password" class="form-label">ë¹„ë°€ë²ˆí˜¸</label>
                    <input 
                        type="password" 
                        id="password" 
                        name="password" 
                        class="form-input" 
                        placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”"
                        required
                    />
                </div>

                <button type="submit" class="submit-button" id="loginButton">
                    <span id="loginButtonText">ë¡œê·¸ì¸</span>
                    <div class="loading-spinner" id="loginSpinner" style="display: none;"></div>
                </button>
            </form>

            <div class="form-footer">
                <p>
                    ê³„ì •ì´ ì—†ìœ¼ì‹ ê°€ìš”?
                    <a href="/signup" class="signup-link">íšŒì›ê°€ì…</a>
                </p>
                <p>
                    <a href="/forgot-password" class="forgot-password">ì•„ì´ë””/ë¹„ë°€ë²ˆí˜¸ ì°¾ê¸°</a>
                </p>
            </div>
        </div>
    </div>

    <script src="/js/theme-toggle.js"></script>
    <script src="/js/common/api.js"></script>
    <script>
        const loginForm = document.querySelector("form[name=form-login]");
        const loginButton = document.getElementById('loginButton');
        const loginButtonText = document.getElementById('loginButtonText');
        const loginSpinner = document.getElementById('loginSpinner');
        const errorMessage = document.getElementById('errorMessage');
        const loginGifIcon = document.querySelector('.login-gif-icon');

        // í…Œë§ˆ ë³€ê²½ ì‹œ GIF ì•„ì´ì½˜ë„ ì—…ë°ì´íŠ¸
        document.addEventListener('themeChanged', (e) => {
            if (loginGifIcon) {
                console.log("theme: ", e.detail.theme);
                loginGifIcon.src = e.detail.theme === 'white' ? '../image/mobius-lux.gif' : '../image/mobius-nox.gif';
            }
        });

        loginForm.addEventListener('submit', async function(e) {
            e.preventDefault();

            const formData = new FormData(loginForm);
            const data = Object.fromEntries(formData.entries());

            // Show loading state
            isCompleted(false)

            try {
                const response = await window.api.post('/api/v1/auth/login', data, false);

                if (response && response.ok) {
                    const result = await response.json();

                    // access_tokenì„ localStorageì— ì €ì¥
                    window.api.setAccessToken(result.access_token);

                    // ë¡œê·¸ì¸ ì„±ê³µ í›„ í™ˆí˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
                    window.location.href = '/nexus';
                } else if (response) {
                    const error = await response.json();
                    showError(error.detail || 'ê³„ì •ì´ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error('Login error:', error);
                showError('ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
            } finally {
                isCompleted(true)

            }
        });

        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
        }

        function isCompleted(flag) {
            loginButton.disabled = !flag;
            loginButtonText.textContent = !flag ? "ë¡œê·¸ì¸ ì¤‘..." : "ë¡œê·¸ì¸";
            loginSpinner.style.display = !flag ? "inline-block" : "none";
        }

        document.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !loginButton.disabled) {
                loginForm.dispatchEvent(new Event('submit'));
            }
        });
    </script>
</body>
</html>