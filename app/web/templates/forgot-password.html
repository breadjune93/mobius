<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>에이전트 Alpha - 아이디/비밀번호 찾기</title>
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/5/w3.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="/css/chat.css">
    <link rel="stylesheet" href="/css/form.css">
</head>
<style>
    .forgot-tabs {
        display: flex;
        margin-bottom: 20px;
    }

    .tab-button {
        flex: 1;
        padding: 12px 16px;
        background: transparent;
        border: none;
        color: var(--light-300);
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.3s ease;
        border-bottom: 2px solid transparent;
    }

    .tab-button:hover {
        color: var(--light-100);
        border-bottom: 1px solid var(--light-300);
    }

    .tab-button.active {
        border-bottom: 1px solid var(--light-300);
    }

    .tab-content {
        display: none;
    }

    .tab-content.active {
        display: block;
    }

    .login-footer p {
        margin: 8px 0;
    }

    .white-theme .tab-button {
        color: var(--dark-300);
    }

    .white-theme .tab-button:hover {
        border-bottom: 1px solid var(--dark-300);
    }

    .white-theme .tab-button.active {
        border-bottom: 1px solid var(--dark-300);
    }
</style>
<body>

    <div class="form-container">
        <!-- Theme Toggle Button -->
        <div class="theme-toggle-container">
            <button class="theme-toggle" id="themeToggle">
                <div class="theme-toggle-slider">
                    <span class="theme-icon theme-icon-dark">🌙</span>
                    <span class="theme-icon theme-icon-light">☀️</span>
                </div>
            </button>
        </div>

        <div class="form-card">
            <div class="form-header">
                <h1 class="form-logo">
                    <img src="/image/mobius-nox.gif" alt="Mobius" class="login-gif-icon" />
                </h1>
                <p class="form-title">아이디 또는 비밀번호를 찾으세요</p>
            </div>

            <!-- Tab Navigation -->
            <div class="forgot-tabs">
                <button class="tab-button active" id="findIdTab" onclick="showTab('findId')">아이디 찾기</button>
                <button class="tab-button" id="findPasswordTab" onclick="showTab('findPassword')">비밀번호 찾기</button>
            </div>

            <!-- Find ID Form -->
            <div id="findIdForm" class="tab-content active">
                <form class="form-area" id="findIdFormElement">
                    <div class="error-message" id="findIdError"></div>
                    <div class="success-message" id="findIdSuccess" style="display: none;"></div>

                    <div class="form-group">
                        <label for="findIdEmail" class="form-label">이메일 주소</label>
                        <input
                            type="email"
                            id="findIdEmail"
                            name="email"
                            class="form-input"
                            placeholder="등록된 이메일 주소를 입력하세요"
                            required
                        />
                        <small class="form-help">등록 시 사용한 이메일을 입력하시면 아이디를 안내해드립니다.</small>
                    </div>

                    <button type="submit" class="submit-button" id="findIdButton">
                        <span id="findIdButtonText">아이디 찾기</span>
                        <div class="loading-spinner" id="findIdSpinner" style="display: none;"></div>
                    </button>
                </form>
            </div>

            <!-- Find Password Form -->
            <div id="findPasswordForm" class="tab-content">
                <form class="form-area" id="findPasswordFormElement">
                    <div class="error-message" id="findPasswordError"></div>
                    <div class="success-message" id="findPasswordSuccess" style="display: none;"></div>

                    <div class="form-group">
                        <label for="findPasswordUsername" class="form-label">아이디</label>
                        <input
                            type="text"
                            id="findPasswordUsername"
                            name="username"
                            class="form-input"
                            placeholder="아이디를 입력하세요"
                            required
                        />
                    </div>

                    <div class="form-group">
                        <label for="findPasswordEmail" class="form-label">이메일 주소</label>
                        <input
                            type="email"
                            id="findPasswordEmail"
                            name="email"
                            class="form-input"
                            placeholder="등록된 이메일 주소를 입력하세요"
                            required
                        />
                        <small class="form-help">임시 비밀번호를 발송할 이메일 주소입니다.</small>
                    </div>

                    <button type="submit" class="submit-button" id="findPasswordButton">
                        <span id="findPasswordButtonText">비밀번호 재설정</span>
                        <div class="loading-spinner" id="findPasswordSpinner" style="display: none;"></div>
                    </button>
                </form>
            </div>

            <div class="form-footer">
                <p>
                    계정이 없으신가요?
                    <a href="/signup" class="forgot-password">회원가입</a>
                </p>
            </div>
        </div>
    </div>

    <script src="/js/theme-toggle.js"></script>
    <script>
        const loginGifIcon = document.querySelector('.login-gif-icon');

        // 테마 변경 시 GIF 아이콘도 업데이트
        document.addEventListener('themeChanged', (e) => {
            if (loginGifIcon) {
                loginGifIcon.src = e.detail.theme === 'white' ? '../image/mobius-lux.gif' : '../image/mobius-nox.gif';
            }
        });

        // Tab switching function
        function showTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });

            // Remove active class from all tab buttons
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });

            // Show selected tab content
            document.getElementById(tabName + 'Form').classList.add('active');
            document.getElementById(tabName + 'Tab').classList.add('active');

            // Clear messages
            clearMessages();
        }

        function clearMessages() {
            document.querySelectorAll('.error-message, .success-message').forEach(msg => {
                msg.style.display = 'none';
                msg.textContent = '';
            });
        }

        // Find ID Form Handler
        document.getElementById('findIdFormElement').addEventListener('submit', async function(e) {
            e.preventDefault();

            const email = document.getElementById('findIdEmail').value;
            const button = document.getElementById('findIdButton');
            const buttonText = document.getElementById('findIdButtonText');
            const spinner = document.getElementById('findIdSpinner');
            const errorMsg = document.getElementById('findIdError');
            const successMsg = document.getElementById('findIdSuccess');

            // Clear previous messages
            errorMsg.style.display = 'none';
            successMsg.style.display = 'none';

            // Show loading state
            button.disabled = true;
            buttonText.textContent = '검색 중...';
            spinner.style.display = 'inline-block';

            try {
                const response = await fetch('/find-id', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ email: email })
                });

                const result = await response.json();

                if (response.ok) {
                    successMsg.textContent = `해당 이메일로 등록된 아이디는 "${result.username}" 입니다.`;
                    successMsg.style.display = 'block';
                    document.getElementById('findIdFormElement').reset();
                } else {
                    errorMsg.textContent = result.message || '해당 이메일로 등록된 계정을 찾을 수 없습니다.';
                    errorMsg.style.display = 'block';
                }
            } catch (error) {
                console.error('Find ID error:', error);
                errorMsg.textContent = '서버에 연결할 수 없습니다. 잠시 후 다시 시도해주세요.';
                errorMsg.style.display = 'block';
            } finally {
                // Reset button state
                button.disabled = false;
                buttonText.textContent = '아이디 찾기';
                spinner.style.display = 'none';
            }
        });

        // Find Password Form Handler
        document.getElementById('findPasswordFormElement').addEventListener('submit', async function(e) {
            e.preventDefault();

            const username = document.getElementById('findPasswordUsername').value;
            const email = document.getElementById('findPasswordEmail').value;
            const button = document.getElementById('findPasswordButton');
            const buttonText = document.getElementById('findPasswordButtonText');
            const spinner = document.getElementById('findPasswordSpinner');
            const errorMsg = document.getElementById('findPasswordError');
            const successMsg = document.getElementById('findPasswordSuccess');

            // Clear previous messages
            errorMsg.style.display = 'none';
            successMsg.style.display = 'none';

            // Show loading state
            button.disabled = true;
            buttonText.textContent = '전송 중...';
            spinner.style.display = 'inline-block';

            try {
                const response = await fetch('/reset-password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        username: username,
                        email: email
                    })
                });

                const result = await response.json();

                if (response.ok) {
                    successMsg.textContent = '임시 비밀번호가 이메일로 전송되었습니다. 이메일을 확인해주세요.';
                    successMsg.style.display = 'block';
                    document.getElementById('findPasswordFormElement').reset();
                } else {
                    errorMsg.textContent = result.message || '입력한 정보와 일치하는 계정을 찾을 수 없습니다.';
                    errorMsg.style.display = 'block';
                }
            } catch (error) {
                console.error('Reset password error:', error);
                errorMsg.textContent = '서버에 연결할 수 없습니다. 잠시 후 다시 시도해주세요.';
                errorMsg.style.display = 'block';
            } finally {
                // Reset button state
                button.disabled = false;
                buttonText.textContent = '비밀번호 재설정';
                spinner.style.display = 'none';
            }
        });

        // Enter key handling
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                const activeForm = document.querySelector('.tab-content.active form');
                if (activeForm) {
                    const submitButton = activeForm.querySelector('button[type="submit"]');
                    if (submitButton && !submitButton.disabled) {
                        activeForm.dispatchEvent(new Event('submit'));
                    }
                }
            }
        });
    </script>
</body>
</html>